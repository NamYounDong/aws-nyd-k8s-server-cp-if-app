containers:
  - name: redis
    # Redis 7.4 Alpine 기반 이미지 (경량, 빠른 기동)
    image: redis:7.4-alpine

    # 노드에 이미지가 있으면 재다운로드하지 않음
    imagePullPolicy: IfNotPresent

    ports:
      # Redis 서비스 포트
      # Service targetPort에서 이름으로도 참조 가능
      - name: redis
        containerPort: 6379

    # ===============================
    # 실행 명령 (패스워드 적용)
    # ===============================

    # sh -lc 를 사용하는 이유:
    # - $REDIS_PASSWORD 같은 환경변수 확장을 쉘에서 처리하기 위함
    # - exec를 사용해 PID 1로 redis-server를 실행(시그널 정상 처리)
    command: ["sh","-lc"]

    args:
      # redis-server를 설정 파일 기반으로 실행하면서
      # Secret에서 주입된 패스워드를 --requirepass 옵션으로 적용
      - >
        exec redis-server /usr/local/etc/redis/redis.conf
        --requirepass "$REDIS_PASSWORD"

    # ===============================
    # 환경변수 주입 (Secret)
    # ===============================

    # redis-auth Secret에 정의된 모든 key/value를 환경변수로 주입
    # 예: REDIS_PASSWORD=<value>
    envFrom:
      - secretRef:
          name: redis-auth

    # ===============================
    # 리소스 관리 (QoS/안정성)
    # ===============================

    resources:
      # 최소 보장 리소스
      # → 노드 부하 상황에서도 Redis 생존 보장
      requests:
        cpu: "50m"
        memory: "256Mi"

      # 최대 사용 제한
      # → 폭주 시 노드 전체 장애 방지
      limits:
        cpu: "300m"
        memory: "512Mi"

    # ===============================
    # 헬스체크 (인증 포함)
    # ===============================

    # livenessProbe:
    # - 컨테이너가 "살아있는지" 확인
    # - 인증을 포함하지 않으면 NOAUTH 에러로 오탐지될 수 있음
    livenessProbe:
      exec:
        # redis-cli에 -a 옵션으로 패스워드 전달
        # PONG 응답이면 정상
        command: ["sh","-lc","redis-cli -a \"$REDIS_PASSWORD\" ping | grep -q PONG"]
      # 초기 기동/데이터 로드 시간 고려
      initialDelaySeconds: 15
      periodSeconds: 10
      timeoutSeconds: 3
      # 연속 실패 6회 시 재시작
      failureThreshold: 6

    # readinessProbe:
    # - 트래픽을 받아도 되는 상태인지 확인
    # - 실패 시 Service 엔드포인트에서 제외
    readinessProbe:
      exec:
        command: ["sh","-lc","redis-cli -a \"$REDIS_PASSWORD\" ping | grep -q PONG"]
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 3
      # 연속 실패 3회 시 준비 안됨 처리
      failureThreshold: 3

    # ===============================
    # 컨테이너 보안 하드닝
    # ===============================

    securityContext:
      # 컨테이너 내 권한 상승 금지
      allowPrivilegeEscalation: false

      # root 사용자로 실행 금지
      runAsNonRoot: true

      # Redis 프로세스를 특정 UID/GID로 실행
      # (fsGroup과 조합하여 PVC 쓰기 권한 확보)
      runAsUser: 999
      runAsGroup: 999

      # 모든 Linux capability 제거 (최소 권한 원칙)
      capabilities:
        drop: ["ALL"]

    # ===============================
    # 볼륨 마운트
    # ===============================

    volumeMounts:
      # ConfigMap의 redis.conf를 컨테이너 설정 파일로 마운트
      # subPath 사용으로 디렉터리 전체가 아닌 단일 파일만 덮어씀
      - name: redis-config
        mountPath: /usr/local/etc/redis/redis.conf
        subPath: redis.conf
        readOnly: true

      # Redis 데이터 디렉터리
      # AOF / RDB 파일이 PVC에 영속 저장됨
      - name: redis-data
        mountPath: /data
