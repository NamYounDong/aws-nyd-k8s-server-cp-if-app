apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: ingress-nginx-controller     # ingress-nginx ì»¨íŠ¸ë¡¤ëŸ¬ DaemonSet
  namespace: edge                    # edge ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë°°ì¹˜
  labels:
    app: ingress-nginx               # ingress-nginx ì‹ë³„ ë¼ë²¨
spec:
  # DaemonSetì´ ê´€ë¦¬í•  Pod ì„ íƒ ê¸°ì¤€
  selector:
    matchLabels:
      app: ingress-nginx

  template:
    metadata:
      labels:
        app: ingress-nginx           # Service / NetworkPolicy / Selectorì™€ ë§¤ì¹­
    spec:
      serviceAccountName: ingress-nginx   # RBAC ê¶Œí•œì´ ë¶€ì—¬ëœ ServiceAccount ì‚¬ìš©

      # --------------------------------------------------
      # ğŸ”‘ í•µì‹¬ ì„¤ì •
      # --------------------------------------------------

      # hostNetwork=true
      # - Podê°€ ë…¸ë“œì˜ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ì§ì ‘ ì‚¬ìš©
      # - ë…¸ë“œì˜ 80/443 í¬íŠ¸ë¥¼ "ë°”ë¡œ" ìˆ˜ì‹  ê°€ëŠ¥
      # - NodePort / LoadBalancer ì—†ì´ ë„ë©”ì¸ 80/443 ì§ì ‘ ì²˜ë¦¬
      hostNetwork: true

      # hostNetwork ì‚¬ìš© ì‹œ í•„ìˆ˜
      # - í´ëŸ¬ìŠ¤í„° DNS(kube-dns/CoreDNS) ì •ìƒ ì‚¬ìš© ë³´ì¥
      dnsPolicy: ClusterFirstWithHostNet

      # --------------------------------------------------
      # íŠ¹ì • ì›Œì»¤ ë…¸ë“œì—ë§Œ Ingress ë°°ì¹˜
      # --------------------------------------------------

      # ì´ ë¼ë²¨ì„ ê°€ì§„ ë…¸ë“œì—ë§Œ ingress-nginx ë°°ì¹˜
      # ì˜ˆ:
      #   kubectl label node <node> role=worker
      #   kubectl label node <node> edge-ingress=enabled
      nodeSelector:
        role: worker-app
        edge-ingress: enabled

      # Pod ì¢…ë£Œ ì‹œ íŠ¸ë˜í”½ ì •ë¦¬ë¥¼ ìœ„í•œ ìœ ì˜ˆ ì‹œê°„
      terminationGracePeriodSeconds: 30

      containers:
        - name: controller
          image: registry.k8s.io/ingress-nginx/controller:v1.9.6
          imagePullPolicy: IfNotPresent

          # --------------------------------------------------
          # ingress-nginx ì‹¤í–‰ ì˜µì…˜
          # --------------------------------------------------
          args:
            - /nginx-ingress-controller
            - --ingress-class=nginx                    # ì²˜ë¦¬í•  IngressClass ì´ë¦„
            - --configmap=edge/ingress-nginx-controller # ì„¤ì • ConfigMap ì°¸ì¡°
            - --watch-ingress-without-class=false      # class ì—†ëŠ” ingress ë¬´ì‹œ
            - --http-port=80                           # HTTP ìˆ˜ì‹  í¬íŠ¸
            - --https-port=443                         # HTTPS ìˆ˜ì‹  í¬íŠ¸

          # --------------------------------------------------
          # ì»¨í…Œì´ë„ˆ í¬íŠ¸
          # hostNetwork=true ì´ë¯€ë¡œ ë…¸ë“œ í¬íŠ¸ì™€ ë™ì¼
          # --------------------------------------------------
          ports:
            - name: http
              containerPort: 80                        # HTTP
            - name: https
              containerPort: 443                       # HTTPS
            - name: metrics
              containerPort: 10254                     # ìƒíƒœ/ë©”íŠ¸ë¦­/í—¬ìŠ¤ì²´í¬

          # --------------------------------------------------
          # í—¬ìŠ¤ ì²´í¬
          # --------------------------------------------------
          livenessProbe:
            httpGet:
              path: /healthz
              port: 10254
            initialDelaySeconds: 10
            periodSeconds: 10

          readinessProbe:
            httpGet:
              path: /ready
              port: 10254
            initialDelaySeconds: 10
            periodSeconds: 10

          # --------------------------------------------------
          # ë¦¬ì†ŒìŠ¤ ìš”ì²­/ì œí•œ
          # --------------------------------------------------
          resources:
            requests:
              cpu: "100m"                              # ìµœì†Œ CPU ë³´ì¥
              memory: "256Mi"                          # ìµœì†Œ ë©”ëª¨ë¦¬ ë³´ì¥
            limits:
              cpu: "500m"                              # ìµœëŒ€ CPU ì‚¬ìš©ëŸ‰
              memory: "512Mi"                          # ìµœëŒ€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰

          # --------------------------------------------------
          # ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸
          # --------------------------------------------------
          securityContext:
            allowPrivilegeEscalation: false             # ê¶Œí•œ ìƒìŠ¹ ê¸ˆì§€
            runAsNonRoot: true                          # root ì‚¬ìš©ì ê¸ˆì§€
            runAsUser: 101                              # ë¹„root UID ì‚¬ìš©
            capabilities:
              drop: ["ALL"]                             # ëª¨ë“  Linux capability ì œê±°
              add: ["NET_BIND_SERVICE"]                 # 1024 ì´í•˜ í¬íŠ¸(80/443) ë°”ì¸ë”© í—ˆìš©
